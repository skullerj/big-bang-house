<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/datetime-picker/calendar-element.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="components/schedule-input.html">

<dom-module id="admin-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
      div.main{
        height: calc(100vh - 90px);
        width: 100%;
      }
      div.login{
        width: 300px;
      }
      div.rooms-container{
        min-width: 70%;
      }
      div.rooms{
        @apply --shadow-elevation-2dp;
        width: 100%;
        height: 300px;
        position: relative;
        background-color: #fff;
      }
      div.rooms-grid{
        @apply --layout-horizontal;
        @apply --layout-center-justified;
        overflow-x: auto;
      }
      div.room{
        @apply --layout-vertical;
        background-color: var(--light-secondary-color);
        color: var(--light-secondary-text-color);
        width: 250px;
        height: 80px;
        padding: 1rem;
        margin: 0.5rem;
      }
      paper-fab.add{
        position: absolute;
        right: 10px;
        top: -20px;
      }
      section{
        height: 90vh;
      }
      div.inputs-container{
        max-width: 350px;
      }
      #addDialog{
        min-width: 300px;
      }
      #deleteDialog{
        max-width: 300px;
      }
      calendar-element{
        margin-right: 1rem;
      }
      .card-content{
        min-height: 6rem!important;
      }
      div.apointment{
        margin-bottom: 1rem;
        background-color: rgba(0, 0, 0, 0.05);
      }
      paper-card.apointments{
        width: 33vw;
      }
      div.hours{
        font-size: 0.7rem;
      }
    </style>
    <app-route
        route="{{route}}"
        pattern="/admin/:id"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>
    <div class="main vertical center" hidden$="[[user.authenticated]]">
      <div class="vertical card login">
        <span class="font-subhead mb-1">Iniciar sesión</span>
        <paper-input label="Email" id="email" required></paper-input>
        <paper-input label="Contraseña" id="password" type="password" class="mb-1" required></paper-input>
        <paper-button class="accent self-end" on-tap="logIn">Iniciar Sesión</paper-button>
      </div>
    </div>
    <div class="main" hidden$="[[!user.authenticated]]">
      <iron-pages selected="[[page]]" attr-for-selected="name">
        <section name="resume" class="vertical center">
          <div class="rooms-container">
            <span class="font-display2 m2-b">Salas disponibles</span>
            <div class="rooms vertical justified">
              <paper-fab class="add" icon="add" on-tap="openAddDialog"></paper-fab>
              <span hidden$="[[noRooms]]">No hay ninguna sala disponible</span>
              <div class="rooms-grid">
                <template is="dom-repeat" items="[[rooms]]">
                  <div class="room">
                    <span class="font-title">[[item.name]]</span>
                    <div class="flex"></div>
                    <a href="/admin/[[item.id]]" class="self-end">
                      <paper-button>Administrar</paper-button>
                    </a>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </section>
        <section name="edit">
          <div class="vertical">
            <div class="horizontal">
              <span class="font-display1 flex">[[selectedRoom.name]]</span>
              <paper-button raised>Visitar</paper-button>
            </div>
            <div class="horizontal">
              <div class="inputs-container flex-2 p2 vertical">
                <paper-input label="Nombre" value="{{selectedRoom.name}}"></paper-input>
                <paper-textarea value="{{selectedRoom.description}}" label="Descripción" rows="3" max-rows="4"></paper-textarea>
                <paper-textarea value="{{selectedRoom.amenities}}" label="Amenidades" rows="3" max-rows="5"></paper-textarea>
                <div class="horizontal">
                  <div class="flex"></div>
                  <paper-button class="accent" on-tap="openDeleteDialog">Eliminar Sala</paper-button>
                  <paper-button raised class="accent" on-tap="saveRoom">Guardar</paper-button>
                </div>
              </div>
              <div class="vertical flex-3 p2">
                <span class="font-title">Horario de la sala</span>
                <schedule-input value="{{selectedRoom.schedule}}"></schedule-input>
              </div>
            </div>
            <div class="vertical">
              <span class="font-title">Reservaciones</span>
              <div class="htv">
                <calendar-element date="{{date}}"></calendar-element>
                <paper-card class="apointments" heading="[[parseDate(date)]]">
                  <div class="card-content">
                    <template is="dom-repeat" items="[[apointments]]">
                      <div class="apointment vertical" style="height:[[computeLength(item)]]">
                        <div class="horizontal">
                          <div class="hours flex">
                            [[parseTime(item.start)]]
                          </div>
                          <paper-icon-button class="close" icon="close" on-tap="spliceApointment"></paper-icon-button>
                        </div>
                        <div class="flex vertical">
                          [[item.subject]]
                        </div>
                        <div class="hours">
                          [[parseTime(item.end)]]
                        </div>
                      </div>
                    </template>
                  </div>
                  <div class="card-actions vertical">
                    <div class="">
                      <div class="horizontal">
                        <paper-time-input id="apStartInput" class="m1-r" label="Inicio" format="24"></paper-time-input>
                        <paper-time-input id="apEndInput" label="Fin" format="24"></paper-time-input>
                      </div>
                      <paper-input id="apSubInput" label="tema"></paper-input>
                    </div>
                    <paper-button class="accent horizontal self-end" on-tap="insertReservation">Agregar</paper-button>
                  </div>
                </paper-card>
              </div>
            </div>
          </div>
        </section>
      </iron-pages>
    </div>
    <paper-dialog id="addDialog">
      <h2>Nueva sala</h2>
      <paper-input label="Nombre" value="{{newRoom.name}}"></paper-input>
      <div class="buttons">
        <paper-button class="accent" on-tap="closeAddDialog">Cancelar</paper-button>
        <paper-button raised class="accent" on-tap="createRoom">Crear</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="deleteDialog" class="vertical">
      <h2>Eliminar</h2>
      <span>¿Estás seguro de eliminar esta sala? Todas las reservaciones debajo de esta sala se perderán.</span>
      <div class="buttons">
        <paper-button class="accent" dialog-dismiss>Cancelar</paper-button>
        <paper-button class="accent" raised on-tap="deleteRoom">Eliminar</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    const room = {
      name:null,
      description:null,
      amenities:null,
      schedule:{
        mon:[],
        tue:[],
        wed:[],
        thu:[],
        fri:[],
        sat:[],
        sun:[]
      },
      apointments:{}
    }
    class AdminView extends GlobalStoreMixin(UserActionsMixin(RoomsActionsMixin(Polymer.Element))) {
      static get is() { return 'admin-view'; }
      static get properties(){
        return {
          user:{
            type:Object,
            statePath:'user'
          },
          page:{
            type:String,
            value:'resume'
          },
          rooms:{
            type:Array,
            statePath:(state)=>{
              var entities= state.rooms.entities;
              var result=[];
              Object.keys(entities).forEach((key)=>{
                result.push(Object.assign({},entities[key],{id:key}));
              });
              return result;
            }
          },
          selectedRoom:{
            type:Object,
            statePath:(state)=>{
              console.log('room changed',state.rooms.entities);
              var room=state.rooms.entities[state.rooms.selectedRoom];
              if(room){
                room.id=state.rooms.selectedRoom;
                return room;
              }else{
                return null;
              }
            }
          },
          noRooms:{
            type:Boolean,
            statePath:(state)=>{
              return Object.keys(state.rooms.entities).length>0;
            }
          },
          newRoom:{
            type:Object,
            value:function(){
              return room;
            }
          },
          route:Object,
          subroute:Object,
          routeData:Object,
          date : Date,
          apointments :{
            type: Array,
            computed : 'conputeApointments(date,selectedRoom)'
          }
        }
      }
      static get observers(){
        return ['_userAuthChange(user.authenticated)','_routeIdChange(route.path)'];
      }
      constructor(){
        super();
      }
      logIn(){
        if(this._validateLogin()){
          this.dispatch('logIn',this.$.email.value,this.$.password.value,(err,result)=>{
            if(err)return showMessage('Hubo un error logeandote');
            showMessage('Bienvenid@');
          });
        }
      }
      _routeIdChange(path){
        if(path==='/admin'){
          return this.page='resume';
        }
        if(this.routeData.id){
          this.dispatch('selectRoom',this.routeData.id);
          this.page='edit';
        }
      }
      _userAuthChange(newVal){
        if(newVal){
          this.dispatch('loadRooms',(err,rooms)=>{
            if(err)showMessage('Hubo un error cargando las salas');
          });
        }
      }
      _validateLogin(){
        return this.$.email.validate()&&this.$.password.validate();
      }
      openAddDialog(){
        this.$.addDialog.open();
      }
      closeAddDialog(){
        this.$.addDialog.close();
        this.set('newRoom',room);
      }
      openDeleteDialog(){
        this.$.deleteDialog.open();
      }
      createRoom(){
        this.dispatch('createRoom',this.newRoom,(err,room)=>{
          if(err)return showMessage('Hubo un error creando la sala');
          showMessage('Nueva sala agregada');
          redirect(`/admin/${room.id}`);
          this.closeAddDialog();
        });
      }
      saveRoom(){
        this.dispatch('updateRoom',this.selectedRoom,(err)=>{
          if(err)return showMessage('Hubo un error actualizando la sala');
          showMessage('Se ha guardado tu sala');

        });
      }
      deleteRoom(){
        this.dispatch('deleteRoom',this.selectedRoom.id,(err)=>{
          if(err)return showMessage('Hubo un error borrando la sala');
          showMessage('Se ha eliminado la sala');
          this.$.deleteDialog.close();
          redirect('/admin');
        });
      }
      insertReservation(){
        var date = new Date(this.date),
            avalible = true;
        var newApointment = {
          start : parseInt(this.$.apStartInput.hour*60)+ parseInt(this.$.apStartInput.min),
          end : parseInt(this.$.apEndInput.hour*60)+ parseInt(this.$.apEndInput.min),
          subject : this.$.apSubInput.value
        };
        var newStart = newApointment.start;
        var newEnd = newApointment.end;
        date.setHours(0,0,0,0);
        var schedule;
        switch(date.getDay()){
          case 0:
            schedule = this.selectedRoom.schedule['sun'];
          break;
          case 1:
            schedule = this.selectedRoom.schedule['mon'];
          break;
          case 2:
            schedule = this.selectedRoom.schedule['tue'];
          break;
          case 3:
            schedule = this.selectedRoom.schedule['wed'];
          break;
          case 4:
            schedule = this.selectedRoom.schedule['thu'];
          break;
          case 5:
            schedule = this.selectedRoom.schedule['fri'];
          break;
          case 6:
            schedule = this.selectedRoom.schedule['sat'];
          break;
        };
        var apointments;
        if(schedule){
          schedule.forEach((sche)=>{
            if(!(newStart >= sche.start && newEnd <= sche.end)){
              avalible = false;
              console.log('nop');
            }
          });
        }
        this.apointments.forEach((apo)=>{
          var apoStart = apo.start;
          var apoEnd = apo.end;
          if(newStart<= apoStart && newEnd >= apoStart){
            avalible = false;
            return;
          }
          if(newStart >= apoStart && newStart <= apoEnd){
            avalible = false;
            return;
          }
        });
        if (!avalible) {
          return showMessage('No se puede ingresar en este horario');
        }
        this.apointments.push(newApointment);
        var allApointments = Object.assign({},this.selectedRoom.apointments);
        allApointments[date] = this.apointments;
        this.set('selectedRoom.apointments',allApointments);
        this.saveRoom();
      }
      conputeApointments(ldate){
        var date = new Date(ldate);
        date.setHours(0,0,0,0);
        if (!this.selectedRoom||!this.selectedRoom.apointments||!this.selectedRoom.apointments[date]) {
          return [];
        }
        var apointments = this.selectedRoom.apointments[date];
        apointments.sort((a,b)=>{
          if(a.start > b.start){
            return true;
          }
        });
        return this.selectedRoom.apointments[date];
      }
      parseApointment(apo){
        var sMin=apo.start%60;
        if(sMin<10){
          sMin+='0';
        }
        var eMin=apo.end%60;
        if(eMin<10){
          eMin+='0';
        }
        return `${Math.floor(apo.start/60)}:${sMin} - ${Math.floor(apo.end/60)}:${eMin}`
      }
      parseTime(time){
        var min = time%60;
        if(min<10){
          min+='0';
        }
        return `${Math.floor(time/60)}:${min}`;
      }
      parseDate(date){
        var nDate = new Date(date);
        return nDate.toString().split('19')[0];
      }
      spliceApointment(e){
        var date = new Date(this.date);
        date.setHours(0,0,0,0);
        var index = e.model.__data.index;
        this.splice(['apointments'],index,1);
        this.selectedRoom.apointments[date] = this.apointments;
        this.set(['selectedRoom.apointments',date],this.apointments);
        this.saveRoom();
      }
      computeLength(item){
        var length = (item.end-item.start);
        if(length <= 30){
          return '4rem';
        }else if(length <= 60){
          return '5rem';
        }else if(length <= 90){
          return '6rem';
        }else if(length <= 150){
          return '7rem';
        }else{
          return '8rem';
        }
      }
    }

    window.customElements.define(AdminView.is, AdminView);
  </script>
</dom-module>
