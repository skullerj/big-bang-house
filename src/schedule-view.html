<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/datetime-picker/calendar-element.html">

<link rel="import" href="shared-styles.html">

<dom-module id="schedule-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px 20px;
      }
      div.rooms-container{
        min-width: 70%;
      }
      div.rooms{
        @apply --shadow-elevation-2dp;
        width: 100%;
        height: 300px;
        position: relative;
        background-color: #fff;
      }
      div.rooms-grid{
        @apply --layout-horizontal;
        @apply --layout-center-justified;
        overflow-x: auto;
      }
      div.room{
        @apply --layout-vertical;
        background-color: var(--light-secondary-color);
        color: var(--light-secondary-text-color);
        width: 250px;
        height: 80px;
        padding: 1rem;
        margin: 0.5rem;
      }
      paper-fab.add{
        position: absolute;
        right: 10px;
        top: -20px;
      }
      calendar-element{
        margin-right: 1rem;
      }
      .card-content{
        min-height: 6rem!important;
      }
      div.apointment{
        margin-bottom: 1rem;
        background-color: rgba(0, 0, 0, 0.05);
      }
      paper-card.apointments{
        width: 33vw;
      }
      div.hours{
        font-size: 0.7rem;
      }
    </style>
    <app-route
        route="{{route}}"
        pattern="/schedule/:id"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>
    <div class="rooms-container">
      <iron-pages selected="[[page]]" attr-for-selected="name">
        <section name="resume">
          <span class="font-display2 m2-b">Salas disponibles</span>
          <div class="rooms vertical justified">
            <div class="rooms-grid">
              <template is="dom-repeat" items="[[rooms]]">
                <div class="room">
                  <span class="font-title">[[item.name]]</span>
                  <div class="flex"></div>
                  <a href="/schedule/[[item.id]]" class="self-end">
                    <paper-button>Detalles</paper-button>
                  </a>
                </div>
              </template>
            </div>
          </div>
        </section>
        <section name="detail">
          <paper-card heading="[[selectedRoom.name]]">
            <div class="card-content">
              <span>[[selectedRoom.description]]</span>
              <span>[[selectedRoom.amenities]]</span>
            </div>
          </paper-card>
          <div class="vertical">
            <div class="htv">
              <calendar-element date="{{date}}"></calendar-element>
              <paper-card class="apointments" heading="[[parseDate(date)]]">
                <div class="card-content">
                  <template is="dom-repeat" items="[[apointments]]">
                    <div class="apointment vertical" style="height:[[computeLength(item)]]">
                      <div class="horizontal">
                        <div class="hours flex">
                          [[parseTime(item.start)]]
                        </div>
                      </div>
                      <div class="flex">

                      </div>
                      <div class="hours">
                        [[parseTime(item.end)]]
                      </div>
                    </div>
                  </template>
                </div>
              </paper-card>
            </div>
          </div>
        </section>
      </iron-pages>
    </div>
  </template>

  <script>
    class scheduleView extends GlobalStoreMixin(RoomsActionsMixin(Polymer.Element)) {
      static get is() { return 'schedule-view'; }
      static get properties() {
        return {
          // This shouldn't be neccessary, but the Analyzer isn't picking up
          // Polymer.Element#rootPath
          date:Date,
          page:{
            type:String,
            value:'resume'
          },
          rootPath: String,
          rooms:{
            type:Array,
            statePath:(state)=>{
              var entities= state.rooms.entities;
              var result=[];
              console.log('pegelo',state);
              Object.keys(entities).forEach((key)=>{
                result.push(Object.assign({},entities[key],{id:key}));
              });
              return result;
            }
          },
          selectedRoom:{
            type:Object,
            statePath:(state)=>{
              var room=state.rooms.entities[state.rooms.selectedRoom];
              if(room){
                room.id=state.rooms.selectedRoom;
                return room;
              }else{
                return null;
              }
            }
          },
          apointments :{
            type: Array,
            computed : 'conputeApointments(date,selectedRoom)'
          }
        };
      }
      static get observers(){
        return ['_routeIdChange(route.path)'];
      }
      _routeIdChange(path){
        if(path==='/schedule'){
          return this.page='resume';
        }
        if(this.routeData.id){
          this.dispatch('selectRoom',this.routeData.id);
          this.page='detail';
        }
      }
      conputeApointments(ldate){
        var date = new Date(ldate);
        date.setHours(0,0,0,0);
        if (!this.selectedRoom||!this.selectedRoom.apointments||!this.selectedRoom.apointments[date]) {
          return [];
        }
        var apointments = this.selectedRoom.apointments[date];
        apointments.sort((a,b)=>{
          if(a.start > b.start){
            return true;
          }
        });
        return this.selectedRoom.apointments[date];
      }
      parseTime(time){
        var min = time%60;
        if(min<10){
          min+='0';
        }
        return `${Math.floor(time/60)}:${min}`;
      }
      parseDate(date){
        var nDate = new Date(date);
        return nDate.toString().split('19')[0];
      }
      computeLength(item){
        var length = (item.end-item.start);
        if(length <= 30){
          return '4rem';
        }else if(length <= 60){
          return '5rem';
        }else if(length <= 90){
          return '6rem';
        }else if(length <= 150){
          return '7rem';
        }else{
          return '8rem';
        }
      }
    }
    window.customElements.define(scheduleView.is, scheduleView);
  </script>
</dom-module>
